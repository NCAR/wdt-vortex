#!/bin/sh
set -e

# set -x

case "$1" in
    configure)
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
# The debhelper section does a depmod, so do it before
# the modprobe.
#DEBHELPER#

if [ "$1" = "configure" ]; then

    vortex=false
    grep -F "model name" /proc/cpuinfo | grep -F -q Vortex && vortex=true

    # clean out hand edits
    #  cf=/etc/modprobe.d/nidas.conf
    #  sed -i -r -e '/options wdt/d' $cf

    #  cf=/etc/modules-load.d/ads.conf
    #  sed -i -r -e '/wdt/d' $cf

    # comment wdt lines in /etc/rc.local
    cf=/etc/rc.local
    sed -i -r -e 's,^(sh /etc/wdt_load),# \1,' $cf

    # this package includes a udev rule to set permissions on /dev/wdt_vortex
    # According to a web post you don't have to do a
    #   udevadmin control --reload-rules
    # A new rule is "automatically picked up on new udev events".

    # start driver module
    lsmod | fgrep -q wdt_vortex || modprobe wdt_vortex

    # nuke old load, unload scripts
    cf=/etc/wdt_load
    rm -f $cf

    cf=/etc/wdt_unload
    rm -f $cf

fi

exit 0
